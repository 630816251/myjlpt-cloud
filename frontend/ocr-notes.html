<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>OCR æ—¥æ–‡å­¸ç¿’ç­†è¨˜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      margin: 0;
      font-family: "Noto Sans TC", system-ui;
      background: #f5f6f8;
      color: #333;
    }
    header {
      background: #3a6f8f;
      color: #fff;
      padding: 16px 20px;
      font-size: 20px;
      font-weight: 700;
    }
    main {
      max-width: 960px;
      margin: 20px auto;
      padding: 0 16px;
    }
    .card {
      background: #fff;
      border-radius: 10px;
      padding: 16px 18px;
      margin-bottom: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    h2 {
      margin-top: 0;
      color: #3a6f8f;
    }
    .lines p { margin: 4px 0; }
    .vocab span {
      display: inline-block;
      background: #eef3f7;
      border-radius: 20px;
      padding: 6px 12px;
      margin: 4px;
    }
    button {
      background: #3a6f8f;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 14px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<header>ğŸ“˜ OCR æ—¥æ–‡å­¸ç¿’ç­†è¨˜</header>

<main>

  <div class="card">
    <h2>ğŸ“· ä¸Šå‚³ / é¸æ“‡åœ–ç‰‡</h2>

    <input type="file" id="fileInput" accept="image/*" />
    <button id="uploadBtn">ä¸Šå‚³åœ–ç‰‡</button>

    <hr>

    <select id="imageSelect">
      <option value="">é¸æ“‡å·²ä¸Šå‚³åœ–ç‰‡</option>
    </select>

    <button id="loadBtn">å–å¾— OCR çµæœ</button>
  </div>

  <div class="card">
    <h2>ğŸ“„ OCR æ–‡å­—</h2>
    <div id="lines">å°šæœªè¼‰å…¥</div>
  </div>

  <div class="card">
    <h2>â­ é‡é»æ•´ç†</h2>
    <ul id="summary"><li>å°šæœªè¼‰å…¥</li></ul>
  </div>

  <div class="card">
    <h2>ğŸ“ å–®å­—å€™é¸</h2>
    <div id="vocab">å°šæœªè¼‰å…¥</div>
  </div>

</main>

<script>
/* ===== API è¨­å®šï¼ˆè«‹ç¢ºèªé€™æ˜¯ä½  API Gateway çš„ Invoke URLï¼‰ ===== */
const API_BASE = "https://60k6cc5mi6.execute-api.us-east-1.amazonaws.com";
const UPLOAD_URL_API = `${API_BASE}/upload-url`;
const LIST_API = `${API_BASE}/images`;
const OCR_API = `${API_BASE}/ocr/run`;

/* ===== DOM ===== */
const fileInput   = document.getElementById("fileInput");
const uploadBtn   = document.getElementById("uploadBtn");
const imageSelect = document.getElementById("imageSelect");
const loadBtn     = document.getElementById("loadBtn");

const linesEl   = document.getElementById("lines");
const summaryEl = document.getElementById("summary");
const vocabEl   = document.getElementById("vocab");

/* ===== Token ===== */
function getIdToken() {
  return localStorage.getItem("idToken");
}

function authHeaders() {
  const token = getIdToken();
  if (!token) {
    alert("å°šæœªç™»å…¥ï¼Œè«‹å…ˆç™»å…¥");
    throw new Error("No idToken");
  }
  return {
    "Authorization": `Bearer ${token}`,
    "Content-Type": "application/json"
  };
}

/* ===== ä¸Šå‚³åœ–ç‰‡ï¼ˆPresigned URLï¼‰ ===== */
uploadBtn.onclick = async () => {
  const file = fileInput.files[0];
  if (!file) return alert("è«‹é¸æ“‡åœ–ç‰‡");

  try {
    // 1ï¸âƒ£ å–å¾— presigned URL
    const r1 = await fetch(UPLOAD_URL_API, {
      method: "POST",
      headers: authHeaders(),
      body: JSON.stringify({
        filename: file.name,
        contentType: file.type || "image/jpeg"
      })
    });
    const d1 = await r1.json();
    if (!r1.ok) throw new Error(d1.message || "å–å¾—ä¸Šå‚³ç¶²å€å¤±æ•—");

    // 2ï¸âƒ£ PUT ä¸Šå‚³åˆ° S3
    const r2 = await fetch(d1.uploadUrl, {
      method: "PUT",
      headers: { "Content-Type": file.type || "image/jpeg" },
      body: file
    });
    if (!r2.ok) throw new Error("ä¸Šå‚³åˆ° S3 å¤±æ•—");

    alert("âœ… ä¸Šå‚³æˆåŠŸ");
    loadImageList();

  } catch (e) {
    alert("âŒ " + e.message);
    console.error(e);
  }
};

/* ===== è¼‰å…¥åœ–ç‰‡æ¸…å–®ï¼ˆåªæœƒçœ‹åˆ°è‡ªå·±çš„ï¼‰ ===== */
async function loadImageList() {
  try {
    const res = await fetch(LIST_API, {
      headers: { "Authorization": `Bearer ${getIdToken()}` }
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.message || "è¼‰å…¥å¤±æ•—");

    imageSelect.innerHTML = `<option value="">é¸æ“‡å·²ä¸Šå‚³åœ–ç‰‡</option>`;
    data.images.forEach(img => {
      const opt = document.createElement("option");
      opt.value = img.key;
      opt.textContent = img.name;
      imageSelect.appendChild(opt);
    });
  } catch (e) {
    console.error(e);
  }
}

/* ===== OCR ===== */
loadBtn.onclick = async () => {
  const key = imageSelect.value;
  if (!key) return alert("è«‹é¸æ“‡åœ–ç‰‡");

  try {
    const res = await fetch(`${OCR_API}?key=${encodeURIComponent(key)}`, {
      headers: { "Authorization": `Bearer ${getIdToken()}` }
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.message || "OCR å¤±æ•—");

    linesEl.innerHTML = "";
    data.lines.forEach(l => {
      const p = document.createElement("p");
      p.textContent = l;
      linesEl.appendChild(p);
    });

    summaryEl.innerHTML = "";
    data.summary.forEach(s => {
      const li = document.createElement("li");
      li.textContent = s;
      summaryEl.appendChild(li);
    });

    vocabEl.innerHTML = "";
    data.vocab_candidates.forEach(w => {
      const span = document.createElement("span");
      span.textContent = w;
      vocabEl.appendChild(span);
    });

  } catch (e) {
    alert("âŒ " + e.message);
  }
};

/* ===== åˆå§‹åŒ– ===== */
loadImageList();
</script>

</body>
</html>
