<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ç™»å…¥ï½œMyJLPT Cloud</title>

  <style>
    body {
      margin: 0;
      font-family: "æ¨™æ¥·é«”", "Noto Serif TC", serif;
      background-color: #e7f3ec;
    }

    .page {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .panel {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .brand {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 24px;
    }

    .login-box {
      background-color: #ffffff;
      border: 1px solid #cfcfcf;
      padding: 32px 36px;
      width: 420px;
    }

    .input {
      width: 100%;
      padding: 12px;
      font-size: 20px;
      margin-bottom: 16px;
      border: 1px solid #bcbcbc;
      box-sizing: border-box;
    }

    .input:focus {
      background-color: #3a6f8f;
      color: #ffffff;
      outline: none;
    }

    .login-btn {
      width: 100%;
      padding: 12px;
      font-size: 22px;
      background-color: #dcefee;
      border: 1px solid #9fbcbc;
      cursor: pointer;
    }

    .login-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .login-btn:hover:not(:disabled) {
      background-color: #cbe6e3;
    }

    .forgot {
      margin-top: 14px;
      font-size: 16px;
      text-align: center;
    }

    .forgot a {
      color: #3a6f8f;
      text-decoration: none;
    }

    .forgot a:hover {
      text-decoration: underline;
    }

    .register-box {
      margin-top: 24px;
      width: 180px;
      padding: 10px;
      text-align: center;
      background-color: #b9ded9;
      border: 1px solid #7faeb0;
      cursor: pointer;
      font-size: 18px;
    }

    .register-box:hover {
      background-color: #a6d4ce;
    }

    #msg {
      margin-top: 10px;
      font-size: 14px;
      color: red;
      text-align: center;
    }
  </style>
</head>

<body>
<div class="page">
  <div class="panel">

    <div class="brand">MyJLPT Cloud</div>

    <div class="login-box">
      <input id="email" class="input" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ">
      <input id="password" class="input" type="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
      <button class="login-btn" id="btnLogin">ç™» å…¥</button>

      <div class="forgot">
        <a href="forgot-password.html">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ</a>
      </div>

      <div id="msg"></div>
    </div>

    <div class="register-box" onclick="location.href='register.html'">
      å»ºç«‹æ–°å¸³è™Ÿ
    </div>

  </div>
</div>

<script src="config.js"></script>
<script src="auth.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("btnLogin");
  const msg = document.getElementById("msg");

  btn.onclick = async () => {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;

    if (!email || !password) {
      msg.textContent = "è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼";
      return;
    }

    btn.disabled = true;
    msg.textContent = "ç™»å…¥ä¸­...";

    try {
      const result = await login(email, password);

      // ğŸ” ç¬¬ä¸€æ¬¡ç™»å…¥ â†’ å¼·åˆ¶æ”¹å¯†ç¢¼ï¼ˆâš ï¸ æ­¤æ™‚å°šæœªç™»å…¥å®Œæˆï¼‰
      if (result && result.challenge === "NEW_PASSWORD_REQUIRED") {
        sessionStorage.setItem("NEW_PW_SESSION", result.session);
        sessionStorage.setItem("NEW_PW_EMAIL", result.email);
        location.replace("new-password.html");
        return;
      }

      // âœ… åªæœ‰ã€ŒçœŸæ­£ç™»å…¥å®Œæˆã€æ‰æœƒèµ°åˆ°é€™è£¡
      const res = await fetch(`${MYJLPT_CONFIG.API.USER}/me`, {
        method: "GET",
        headers: {
          Authorization: "Bearer " + localStorage.getItem("accessToken")
        }
      });

      if (!res.ok) {
        localStorage.removeItem("accessToken");
        localStorage.removeItem("idToken");
        localStorage.removeItem("refreshToken");

        alert("æ­¤å¸³è™Ÿå·²è¢«åœç”¨æˆ–ä¸å­˜åœ¨ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡ã€‚");
        btn.disabled = false;
        return;
      }

      location.replace("index.html");

    } catch (err) {
      localStorage.removeItem("accessToken");
      localStorage.removeItem("idToken");
      localStorage.removeItem("refreshToken");

      msg.textContent = "ç™»å…¥å¤±æ•—ï¼š" + err.message;
      btn.disabled = false;
    }
  };
});
</script>

</body>
</html>
