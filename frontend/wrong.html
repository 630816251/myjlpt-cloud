<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>æˆ‘çš„éŒ¯é¡Œåº«ï½œMyJLPT</title>

<style>
body{ margin:0; font-family: Helvetica, Arial, "Noto Sans TC"; background:#f5f6f8; }
.wrap{ max-width:720px; margin:30px auto; background:#fff; padding:24px; border-radius:16px; box-shadow:0 10px 24px rgba(0,0,0,.1); }
h1{ margin:0 0 12px; color:#b91c1c; }
.desc{ color:#555; margin-bottom:16px; line-height:1.6; }
.list{ display:flex; flex-direction:column; gap:12px; }
.item{ border:1px solid #ddd; border-radius:12px; padding:14px 16px; display:flex; justify-content:space-between; align-items:center; gap:12px; }
.word{ font-size:18px; font-weight:900; }
.sub{ font-size:13px; color:#666; margin-top:4px; }
.meta{ text-align:right; font-size:13px; color:#666; }
.count{ font-size:18px; font-weight:900; color:#dc2626; }
.empty{ text-align:center; color:#888; padding:40px 0; }
.footer{ margin-top:18px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
button{ padding:10px 16px; border-radius:10px; border:1px solid #ccc; background:#fff; cursor:pointer; font-weight:900; }
.badge{ display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid #ddd; font-weight:900; font-size:12px; color:#444; }
</style>
</head>

<body>
<div class="wrap">
  <h1>âŒ æˆ‘çš„éŒ¯é¡Œåº«</h1>
  <div class="desc">
    ä»¥ä¸‹æ˜¯ä½ åœ¨ç·´ç¿’ä¸­ç­”éŒ¯éçš„å–®å­—ï¼ˆä¾éŒ¯èª¤æ¬¡æ•¸æ’åºï¼‰
    <div style="margin-top:10px;">
      <span class="badge" id="sourceBadge">ä¾†æºï¼šè®€å–ä¸­...</span>
    </div>
  </div>

  <div class="list" id="wrongList"></div>

  <div class="footer">
    <button onclick="goBack()">â† å› VOCAB</button>
    <button onclick="syncNow()">åŒæ­¥æœ¬æ©ŸéŒ¯é¡Œ â†’ é›²ç«¯</button>
    <button onclick="reload()">é‡æ–°è¼‰å…¥</button>
  </div>
</div>

<script src="js/wrong-recorder.js"></script>
<script>
const listEl = document.getElementById("wrongList");
const badgeEl = document.getElementById("sourceBadge");

function goBack(){ location.href = "vocab.html"; }
function reload(){ loadWrong(); }

async function syncNow(){
  badgeEl.textContent = "ä¾†æºï¼šåŒæ­¥ä¸­...";
  const r = await MyJLPTWrong.syncWrongQueueToServer();
  await loadWrong();
  if(r && r.ok){
    alert(`åŒæ­¥å®Œæˆï¼š${r.synced || 0} ç­†ï¼ˆå‰©é¤˜ ${r.remain || 0} ç­†ï¼‰`);
  }else{
    alert("åŒæ­¥å¤±æ•—ï¼šè«‹å…ˆç™»å…¥æˆ–æª¢æŸ¥ API/CORS");
  }
}

function fmt(t){
  if(!t) return "";
  try{
    const d = new Date(t);
    return d.toLocaleString();
  }catch{ return t; }
}

async function loadWrong(){
  listEl.innerHTML = `<div class="empty">è¼‰å…¥ä¸­...</div>`;

  const token = localStorage.getItem("idToken");
  if(!token){
    // ä»ç„¶å…è¨±ç”¨ local é¡¯ç¤ºï¼ˆä½ æƒ³ç¡¬æ€§è¦æ±‚ç™»å…¥ä¹Ÿå¯ä»¥æ”¹æˆ returnï¼‰
    // listEl.innerHTML = `<div class="empty">è«‹å…ˆç™»å…¥</div>`;
    // return;
  }

  const { source, items } = await MyJLPTWrong.getWrongList();
  badgeEl.textContent = `ä¾†æºï¼š${source === "server" ? "DynamoDBï¼ˆé›²ç«¯ï¼‰" : "localStorageï¼ˆæœ¬æ©Ÿï¼‰"}`;

  if(!items || items.length === 0){
    listEl.innerHTML = `<div class="empty">ç›®å‰æ²’æœ‰éŒ¯é¡Œ ğŸ‰</div>`;
    return;
  }

  // ä¿éšªæ’åº
  items.sort((a,b)=> (b.wrongCount||0) - (a.wrongCount||0));

  listEl.innerHTML = "";
  items.forEach(item=>{
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div>
        <div class="word">${item.jp || item.questionId}</div>
        <div class="sub">${item.zh || ""} ${item.tier ? `ãƒ»${item.tier}` : ""} ${item.stage ? `ãƒ»ç¬¬${item.stage}é—œ` : ""}</div>
      </div>
      <div class="meta">
        <div class="count">éŒ¯ ${item.wrongCount || 1} æ¬¡</div>
        <div>${fmt(item.lastWrongAt || item.at)}</div>
      </div>
    `;
    listEl.appendChild(div);
  });
}

loadWrong();
</script>
</body>
</html>
